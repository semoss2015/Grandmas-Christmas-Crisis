<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Help Grandma: Winter Rush</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #ddeeff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Canvas ensures it fills the screen */
        #gameCanvas {
            display: block;
            background-color: #e3f2fd;
        }

        /* UI Overlay */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        /* HUD */
        .hud-bar {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            pointer-events: none;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.85);
            color: #2c3e50;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            border: 2px solid #bdc3c7;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 14px;
        }

        /* Warmth Bar */
        #warmth-container {
            width: 100px;
            height: 15px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid white;
        }
        #warmth-fill {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f1c40f);
            transition: width 0.2s linear;
        }

        /* Message Banner */
        #message-banner {
            position: absolute;
            top: 80px;
            width: 100%;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #d35400;
            text-shadow: 2px 2px 0px white;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
        }
        .show-msg { opacity: 1 !important; }

        /* Screens (Start/Game Over) */
        .screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 15px;
            border-radius: 20px;
            text-align: center;
            width: 90%;
            max-width: 400px;
            max-height: 90vh; 
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            pointer-events: auto;
            border: 4px solid #3498db;
            box-sizing: border-box;
        }

        h1 { margin: 0 0 10px 0; color: #2c3e50; font-size: 24px; }
        p { color: #555; font-size: 14px; line-height: 1.4; margin: 5px 0; }
        
        button {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 15px;
            margin-bottom: 10px;
            font-weight: bold;
            box-shadow: 0 4px 0 #1e8449;
            transition: transform 0.1s;
            width: 100%; 
        }
        button:active { transform: translateY(4px); box-shadow: none; }

        .hidden { display: none !important; }

        /* Icon Canvases in Text */
        .icon-canvas {
            vertical-align: middle;
            margin: 0 5px;
        }

        .mission-list {
            background: #f0f8ff;
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: left;
            font-size: 14px;
        }

        .mission-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            background: white;
            padding: 5px 10px;
            border-radius: 8px;
        }

        /* Leaderboard */
        #leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
            text-align: left;
            font-size: 14px;
            min-height: 50px;
            max-height: 120px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 5px;
        }
        #leaderboard-list li {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #leaderboard-list li:last-child {
            border-bottom: none;
        }
        .rank-badge {
            font-weight: bold;
            color: white;
            background: #3498db;
            padding: 2px 8px;
            border-radius: 12px;
            margin-right: 5px;
        }
        .rank-badge-1 { background: #f1c40f; color: #333; }
        .rank-badge-2 { background: #bdc3c7; color: #333; }
        .rank-badge-3 { background: #c0392b; }
        
        #player-name {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: calc(100% - 22px);
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        
        /* Removed .user-id-display styles */
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="hud-bar" id="hud">
            <div class="stat-box">
                <span>üå°Ô∏è</span>
                <div id="warmth-container"><div id="warmth-fill"></div></div>
            </div>
            <div class="stat-box">
                <span>LEVEL <span id="level-val">1</span></span>
            </div>
            <div class="stat-box">
                <span>üèÜ <span id="score-val">0</span></span>
            </div>
        </div>

        <div id="message-banner">Find the Purse!</div>

        <!-- Start Screen --><div id="start-screen" class="screen">
            <h1>‚ùÑÔ∏è Winter Rush ‚ùÑÔ∏è</h1>
            <p>Grandma is freezing! Bring her items to warm her up.</p>
            
            <div class="mission-list">
                <div class="mission-item">
                    1. Find the Purse <canvas id="icon-purse" width="40" height="40" class="icon-canvas"></canvas> and return it.
                </div>
                <div class="mission-item">
                    2. Return to Grandma <canvas id="icon-grandma" width="40" height="40" class="icon-canvas"></canvas> to level up.
                </div>
                <div class="mission-item">
                    3. Avoid the Grinch <canvas id="icon-grinch" width="40" height="40" class="icon-canvas"></canvas> (They move faster each level).
                </div>
                <div class="mission-item">
                    4. Collect Cocoa <canvas id="icon-cocoa" width="40" height="40" class="icon-canvas"></canvas> to boost Warmth.
                </div>
                <div style="text-align:center; margin-top:10px; font-size:12px; color:#666;">
                    You are the Helper <canvas id="icon-player" width="30" height="30" class="icon-canvas"></canvas>
                </div>
            </div>
            
            <p style="font-size: 12px; color: #7f8c8d; margin-top:0;">(Drag on screen to move)</p>
            <button onclick="startGame()">Start Game</button>
        </div>

        <!-- Game Over Screen --><div id="game-over-screen" class="screen hidden">
            <h1 id="go-title">Game Over</h1>
            <p id="go-msg">You froze!</p>
            <p>Final Score: <strong id="final-score">0</strong></p>
            <p style="font-size: 14px;">Reached Level <span id="final-level">1</span></p>
            
            <div id="highscore-section">
                <p style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">Enter Name to Save Score:</p>
                <input type="text" id="player-name" placeholder="Your Name" maxlength="10">
                <button id="save-score-btn" onclick="submitScore()">Save Score</button>
            </div>
            
            <div style="margin-top: 10px;">
                <strong>Top 3 Helpers (Leaderboard):</strong>
                <ul id="leaderboard-list">
                    <li>Loading...</li>
                </ul>
            </div>
            
            <!-- Removed the user-info-display div --><button onclick="startGame()">Try Again</button>
        </div>
    </div>

<script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, addDoc, onSnapshot, collection, query, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Set Firestore logging to debug
    setLogLevel('Debug');

    // ====================================================================
    // üì¢ IMPORTANT: PUBLIC DEPLOYMENT CONFIGURATION
    // You MUST replace the placeholder values below with your actual 
    // public configuration object from your Firebase console.
    // ====================================================================
   // Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBMlyMbSEW7kJrh0Xjv3DS59u2fvyhIL9o",
  authDomain: "grandmas-christmas-crisis.firebaseapp.com",
  projectId: "grandmas-christmas-crisis",
  storageBucket: "grandmas-christmas-crisis.firebasestorage.app",
  messagingSenderId: "729701269664",
  appId: "1:729701269664:web:f4f8dd9b04d7fd431709c5",
  measurementId: "G-1KZDG4BXPS"
};
    // üõë STEP 2B: Define a static app ID for the leaderboard path
    const appId = "winter-rush-leaderboard"; 
    // ====================================================================

    let app, db, auth;
    let userId = ''; 

    // --- Firebase Initialization and Authentication (Modified for Public Use) ---
    async function initFirebase() {
        if (!PUBLIC_FIREBASE_CONFIG.apiKey.includes("YOUR_API_KEY")) {
            // Use the public config for initialization
            try {
                app = initializeApp(PUBLIC_FIREBASE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);

                // We now use anonymous sign-in, as custom tokens are not available externally.
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated anonymously:", userId);
                        setupLeaderboardListener();
                    } else {
                        console.log("No user signed in.");
                    }
                });
                
            } catch(e) {
                console.error("Firebase initialization or sign-in failed. Did you paste your config? See error:", e);
                document.getElementById('leaderboard-list').innerHTML = "<li>Error: Leaderboard unavailable. Check console.</li>";
            }
        } else {
            console.warn("Firebase configuration is using placeholders. Leaderboard disabled.");
            document.getElementById('leaderboard-list').innerHTML = "<li>Leaderboard disabled (Need config).</li>";
        }
    }
    
    // Leaderboard Collection Path: /artifacts/{appId}/public/data/leaderboard
    // Note: We are using a static, public 'appId' since we are outside the canvas environment.
    const LEADERBOARD_PATH = `artifacts/${appId}/public/data/leaderboard`;

    // Function to set up the real-time leaderboard listener (Top 3 scores)
    function setupLeaderboardListener() {
        if (!db) return;

        const leaderboardRef = collection(db, LEADERBOARD_PATH);
        // NOTE: We rely on the platform to handle the required index for orderBy
        const q = query(leaderboardRef, orderBy("score", "desc"), limit(3)); 

        onSnapshot(q, (snapshot) => {
            const scores = [];
            snapshot.forEach((doc) => {
                scores.push(doc.data());
            });
            renderLeaderboard(scores);
        }, (error) => {
            console.error("Failed to listen to leaderboard changes:", error);
            renderLeaderboard([]);
        });
    }

    // Function to submit the final score (made global for button click)
    window.submitScore = async function() {
        if (!db || !userId) {
            console.error("Firestore not initialized or user not authenticated.");
            alertBox("Cannot save score: Not authenticated or Firestore unavailable.");
            return;
        }

        const name = document.getElementById('player-name').value.trim() || "Helper";
        const score = Math.floor(state.score);
        const submitBtn = document.getElementById('save-score-btn');
        submitBtn.disabled = true;
        submitBtn.innerText = "Saving...";

        const leaderboardRef = collection(db, LEADERBOARD_PATH);

        try {
            await addDoc(leaderboardRef, {
                name: name,
                score: score,
                userId: userId, 
                timestamp: Date.now()
            });
            console.log(`New score saved successfully: ${score} by ${name} (User ID: ${userId})`); // Keep in console for debug
            
            submitBtn.innerText = "Score Saved!";
            document.getElementById('highscore-section').style.display = 'none'; 

        } catch (e) {
            console.error("Score submission failed: ", e);
            alertBox("Score submission failed. Check console for details.");
            submitBtn.innerText = "Save Score (Failed)";
        } finally {
            submitBtn.disabled = false;
        }
    }

    function renderLeaderboard(scores) {
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = "";
        
        if(scores.length === 0) {
            list.innerHTML = "<li>No scores recorded yet.</li>";
            return;
        }
        
        scores.sort((a, b) => b.score - a.score);

        scores.forEach((s, index) => {
            const li = document.createElement('li');
            const rank = index + 1;
            li.innerHTML = `
                <span class="rank-badge rank-badge-${rank}">${rank}</span>
                <span>${s.name}</span>
                <strong>${s.score}</strong>
            `;
            list.appendChild(li);
        });
    }

    // Custom Alert/Message Box function
    function alertBox(message) {
        const modal = document.createElement('div');
        modal.className = 'screen';
        modal.style.zIndex = 1000;
        modal.innerHTML = `
            <h2>Attention</h2>
            <p>${message}</p>
            <button onclick="this.parentNode.remove()">Close</button>
        `;
        document.body.appendChild(modal);
    }
    
    // --- Canvas Setup ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let WIDTH, HEIGHT;
    
    function resize() {
        WIDTH = window.innerWidth;
        HEIGHT = window.innerHeight;
        canvas.width = WIDTH;
        canvas.height = HEIGHT;
    }
    window.addEventListener('resize', resize);
    resize();

    // --- Config ---
    const BASE_CONFIG = {
        playerSpeed: 5,
        grinchBaseSpeed: 0.5,
        baseWarmthDecay: 0.08,
        cocoaHeal: 25
    };

    let state = {
        playing: false,
        level: 1,
        score: 0,
        warmth: 100,
        hasPurse: false,
        frame: 0,
        joystick: { active: false, originX: 0, originY: 0, currX: 0, currY: 0, angle: 0, force: 0 }
    };

    // --- Entities ---
    let player = { x: 0, y: 0, r: 18, dir: 1 };
    let grandma = { x: 60, y: 60 };
    let purse = { x: 0, y: 0 };
    let trees = [];
    let grinches = [];
    let cocoas = [];
    let snow = [];

    // --- Input (Touch & Keyboard) ---
    const handleTouchStart = (e) => {
        if(!state.playing) return;
        const touch = e.changedTouches[0];
        state.joystick.active = true;
        state.joystick.originX = touch.clientX;
        state.joystick.originY = touch.clientY;
        state.joystick.currX = touch.clientX;
        state.joystick.currY = touch.clientY;
    };

    const handleTouchMove = (e) => {
        if(!state.joystick.active) return;
        e.preventDefault();
        const touch = e.changedTouches[0];
        state.joystick.currX = touch.clientX;
        state.joystick.currY = touch.clientY;

        const dx = state.joystick.currX - state.joystick.originX;
        const dy = state.joystick.currY - state.joystick.originY;
        state.joystick.angle = Math.atan2(dy, dx);
        state.joystick.force = Math.min(Math.hypot(dx, dy), 50) / 50;
    };

    const handleTouchEnd = () => {
        state.joystick.active = false;
    };

    canvas.addEventListener('touchstart', handleTouchStart, {passive: false});
    canvas.addEventListener('touchmove', handleTouchMove, {passive: false});
    canvas.addEventListener('touchend', handleTouchEnd);
    
    const keys = {};
    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);

    // --- Game Logic ---
    
    // **FIX: Expose startGame to the global scope so the HTML button can access it.**
    window.startGame = function() {
        state.score = 0;
        state.level = 1;
        startLevel(1);
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        gameLoop();
    }

    function startLevel(levelNum) {
        state.playing = true;
        state.level = levelNum;
        state.warmth = 100;
        state.hasPurse = false;
        state.joystick.active = false;

        document.getElementById('level-val').innerText = state.level;
        document.getElementById('score-val').innerText = state.score;
        showMsg(levelNum === 1 ? "Find the Purse!" : `Level ${levelNum}!`);

        player.x = WIDTH / 2;
        player.y = HEIGHT / 2;
        grandma.x = 80;
        grandma.y = 80;

        // Place purse away from the starting area
        do {
            purse.x = Math.random() * (WIDTH - 100) + 50;
            purse.y = Math.random() * (HEIGHT - 100) + 50;
        } while (Math.hypot(purse.x - 80, purse.y - 80) < 300); 

        // Generate Trees
        trees = [];
        let treeCount = 15 + levelNum * 2;
        for(let i=0; i<treeCount; i++) {
            trees.push({
                x: Math.random() * WIDTH,
                y: Math.random() * HEIGHT,
                r: 30 + Math.random() * 15
            });
        }

        // Generate Grinches
        grinches = [];
        let grinchCount = 1 + Math.floor(levelNum / 2); 
        let grinchSpeed = BASE_CONFIG.grinchBaseSpeed + (levelNum * 0.3);

        for(let i=0; i<grinchCount; i++) {
            let gx, gy;
            do {
                gx = Math.random() * WIDTH;
                gy = Math.random() * HEIGHT;
            } while (Math.hypot(gx - player.x, gy - player.y) < 300); // Spawn away from player

            grinches.push({
                x: gx,
                y: gy,
                vx: Math.random() < 0.5 ? 1 : -1,
                vy: Math.random() < 0.5 ? 1 : -1,
                speed: grinchSpeed
            });
        }

        // Generate Cocoas
        cocoas = [];
        let cocoaCount = Math.max(1, 3 - Math.floor(levelNum / 2)); 
        for(let i=0; i<cocoaCount; i++) {
            cocoas.push({
                x: Math.random() * (WIDTH - 40),
                y: Math.random() * (HEIGHT - 40),
                active: true,
                floatOffset: Math.random() * Math.PI * 2
            });
        }

        // Initialize Snow
        snow = Array.from({length: 80}, () => ({
            x: Math.random() * WIDTH,
            y: Math.random() * HEIGHT,
            r: Math.random() * 2 + 1,
            sp: Math.random() * 2 + 1
        }));
    }

    function showMsg(text) {
        const el = document.getElementById('message-banner');
        el.innerText = text;
        el.classList.add('show-msg');
        setTimeout(() => el.classList.remove('show-msg'), 2500);
    }

    function update() {
        if(!state.playing) return;

        let vx = 0, vy = 0;
        // Handle Joystick input
        if (state.joystick.active) {
            vx = Math.cos(state.joystick.angle) * BASE_CONFIG.playerSpeed * state.joystick.force;
            vy = Math.sin(state.joystick.angle) * BASE_CONFIG.playerSpeed * state.joystick.force;
        } else {
            // Handle Keyboard input
            if (keys['ArrowUp'] || keys['KeyW']) vy = -BASE_CONFIG.playerSpeed;
            if (keys['ArrowDown'] || keys['KeyS']) vy = BASE_CONFIG.playerSpeed;
            if (keys['ArrowLeft'] || keys['KeyA']) vx = -BASE_CONFIG.playerSpeed;
            if (keys['ArrowRight'] || keys['KeyD']) vx = BASE_CONFIG.playerSpeed;
        }

        if (vx !== 0) player.dir = vx > 0 ? 1 : -1;

        let nextX = player.x + vx;
        let nextY = player.y + vy;

        // Keep player in bounds
        nextX = Math.max(20, Math.min(WIDTH - 20, nextX));
        nextY = Math.max(20, Math.min(HEIGHT - 20, nextY));

        // Collision with trees (simple push-back)
        trees.forEach(t => {
            let dist = Math.hypot(nextX - t.x, nextY - t.y);
            const min_dist = 15 + t.r * 0.4; // Player radius + small tree radius
            if (dist < min_dist) { 
                const angle = Math.atan2(nextY - t.y, nextX - t.x);
                nextX = t.x + Math.cos(angle) * min_dist;
                nextY = t.y + Math.sin(angle) * min_dist;
            }
        });

        player.x = nextX;
        player.y = nextY;

        // Warmth Decay
        let decay = BASE_CONFIG.baseWarmthDecay + (state.level * 0.02);
        state.warmth -= decay;
        if (state.warmth <= 0) endGame("You Froze!");
        
        // Update Warmth HUD
        const bar = document.getElementById('warmth-fill');
        bar.style.width = Math.max(0, state.warmth) + "%";
        bar.style.background = state.warmth < 30 ? "red" : "linear-gradient(90deg, #e74c3c, #f1c40f)";

        // Cocoa Collection
        cocoas.forEach(c => {
            if(c.active && Math.hypot(player.x - c.x, player.y - c.y) < 35) {
                c.active = false;
                state.warmth = Math.min(100, state.warmth + BASE_CONFIG.cocoaHeal);
                state.score += 5;
                showMsg("+25 Warmth!");
            }
        });

        // Grinch Movement and Collision
        grinches.forEach(g => {
            // Simple random patrol with occasional bounce
            if(state.frame % 120 === 0) {
                 if (Math.random() < 0.5) g.vx *= -1;
                 else g.vy *= -1;
            }

            g.x += g.vx * g.speed;
            g.y += g.vy * g.speed;
            
            // Bounce off walls
            if(g.x < 20 || g.x > WIDTH - 20) g.vx *= -1;
            if(g.y < 20 || g.y > HEIGHT - 20) g.vy *= -1;
            
            // Collision with player
            if(Math.hypot(player.x - g.x, player.y - g.y) < 30) {
                endGame("The Grinch stole your coat!");
            }
        });

        // Purse and Goal Check
        if (!state.hasPurse) {
            if (Math.hypot(player.x - purse.x, player.y - purse.y) < 30) {
                state.hasPurse = true;
                showMsg("Return to Grandma!");
                state.score += 20;
            }
        } else {
            // Level completion
            if (Math.hypot(player.x - grandma.x, player.y - grandma.y) < 60) {
                let levelBonus = 30 * state.level;
                let warmthBonus = Math.floor(state.warmth * 0.5);
                state.score += levelBonus + warmthBonus;
                showMsg(`Level Complete! +${levelBonus} Bonus!`);
                startLevel(state.level + 1);
            }
        }

        document.getElementById('score-val').innerText = Math.floor(state.score);
        state.frame++;

        // Snow animation
        snow.forEach(s => {
            s.y += s.sp;
            s.x += Math.sin(s.y * 0.01) * 0.5; // Slight wind effect
            if(s.y > HEIGHT) s.y = -5;
        });
    }

    // --- Drawing Functions ---

    function drawGrandma(ctx, x, y) {
        ctx.save();
        ctx.fillStyle = "rgba(0,0,0,0.2)";
        ctx.beginPath(); ctx.ellipse(x, y+25, 20, 10, 0, 0, Math.PI*2); ctx.fill(); 
        
        ctx.fillStyle = "#8e44ad"; 
        ctx.beginPath(); ctx.moveTo(x, y - 20); ctx.lineTo(x + 25, y + 30); ctx.lineTo(x - 25, y + 30); ctx.fill();
        
        ctx.fillStyle = "#f1c40f"; 
        ctx.beginPath(); ctx.arc(x, y - 20, 15, 0, Math.PI*2); ctx.fill();
        
        ctx.fillStyle = "#bdc3c7"; 
        ctx.beginPath(); ctx.arc(x, y - 32, 10, 0, Math.PI*2); ctx.fill();
        
        ctx.strokeStyle = "#333"; ctx.lineWidth = 2; 
        ctx.beginPath(); ctx.arc(x - 5, y - 20, 4, 0, Math.PI*2);
        ctx.moveTo(x - 1, y - 20); ctx.lineTo(x + 1, y - 20);
        ctx.arc(x + 5, y - 20, 4, 0, Math.PI*2); ctx.stroke();

        ctx.beginPath(); ctx.arc(x, y-15, 5, 0, Math.PI, false); ctx.stroke(); 
        ctx.restore();
    }

    function drawPlayer(ctx, x, y, dir = 1) {
        ctx.save();
        ctx.fillStyle = "rgba(0,0,0,0.2)";
        ctx.beginPath(); ctx.ellipse(x, y+20, 15, 5, 0, 0, Math.PI*2); ctx.fill(); 

        ctx.fillStyle = "#3498db"; 
        ctx.beginPath(); ctx.arc(x, y, 16, 0, Math.PI*2); ctx.fill();

        ctx.fillStyle = "#e74c3c"; 
        ctx.beginPath(); ctx.arc(x, y - 5, 16, Math.PI, 0); ctx.fill();
        ctx.fillStyle = "white"; 
        ctx.beginPath(); ctx.arc(x, y - 22, 5, 0, Math.PI*2); ctx.fill();

        ctx.strokeStyle = "#c0392b"; ctx.lineWidth = 6; 
        ctx.beginPath(); ctx.moveTo(x - 10, y + 8); ctx.quadraticCurveTo(x, y + 15, x + 10, y + 8); ctx.stroke();
        
        const sway = Math.sin((state.frame||0) * 0.2) * 5;
        ctx.lineWidth = 5;
        ctx.beginPath(); ctx.moveTo(x - 8, y + 8); ctx.lineTo(x - 8 + sway, y + 20); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(x + 8, y + 8); ctx.lineTo(x + 8 - sway, y + 20); ctx.stroke();


        ctx.fillStyle = "white"; 
        const lookDir = dir * 4;
        ctx.beginPath(); ctx.arc(x - 4 + lookDir, y - 2, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(x + 4 + lookDir, y - 2, 4, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "black"; 
        ctx.beginPath(); ctx.arc(x - 4 + lookDir, y - 2, 1.5, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(x + 4 + lookDir, y - 2, 1.5, 0, Math.PI*2); ctx.fill();
        ctx.restore();
    }

    function drawGrinch(ctx, x, y) {
        ctx.save();
        ctx.fillStyle = "rgba(0,0,0,0.2)";
        ctx.beginPath(); ctx.ellipse(x, y+20, 15, 5, 0, 0, Math.PI*2); ctx.fill();

        ctx.fillStyle = "#27ae60"; 
        ctx.beginPath(); ctx.arc(x, y, 20, 0, Math.PI*2); ctx.fill();
        
        ctx.fillStyle = "#f1c40f"; 
        ctx.beginPath(); ctx.ellipse(x - 6, y - 2, 5, 8, -0.2, 0, Math.PI*2);
        ctx.ellipse(x + 6, y - 2, 5, 8, 0.2, 0, Math.PI*2); ctx.fill();
        
        ctx.fillStyle = "black"; 
        ctx.beginPath(); ctx.arc(x - 6, y - 2, 2, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(x + 6, y - 2, 2, 0, Math.PI*2); ctx.fill();

        ctx.strokeStyle = "black"; ctx.lineWidth = 2; 
        ctx.beginPath(); ctx.moveTo(x - 12, y - 10); ctx.lineTo(x - 2, y - 4);
        ctx.moveTo(x + 12, y - 10); ctx.lineTo(x + 2, y - 4); ctx.stroke();

        ctx.beginPath(); ctx.arc(x, y + 8, 8, Math.PI, 0); ctx.stroke(); 
        ctx.restore();
    }

    function drawTree(ctx, x, y, r) {
        ctx.save();
        ctx.fillStyle = "#795548"; 
        ctx.fillRect(x - r/6, y, r/3, r/2);
        ctx.fillStyle = "#2ecc71"; 
        for(let i=0; i<3; i++) {
            let size = r - (i*5);
            let yPos = y - (i * size * 0.6);
            ctx.beginPath(); ctx.moveTo(x, yPos - size); ctx.lineTo(x + size, yPos + size*0.5); ctx.lineTo(x - size, yPos + size*0.5); ctx.fill();
        }
        ctx.fillStyle = "white"; 
        ctx.beginPath(); ctx.moveTo(x, y - r * 2.8); ctx.lineTo(x + 10, y - r * 2.4); ctx.lineTo(x - 10, y - r * 2.4); ctx.fill();
        ctx.restore();
    }

    function drawPurse(ctx, x, y) {
        ctx.save();
        ctx.fillStyle = "#f39c12"; 
        ctx.fillRect(x - 12, y - 10, 24, 20);
        ctx.fillStyle = "#f1c40f"; 
        ctx.beginPath(); ctx.arc(x, y - 10, 4, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = "#f39c12"; ctx.lineWidth = 3; 
        ctx.beginPath(); ctx.arc(x, y - 10, 10, Math.PI, 0); ctx.stroke();
        
        // Sparkle effect
        if ((state.frame||0) % 30 < 15) {
            ctx.fillStyle = "white"; ctx.font = "16px Arial"; ctx.fillText("‚ú®", x + 10, y - 15);
        }
        ctx.restore();
    }

    function drawCocoa(ctx, x, y) {
        ctx.save();
        ctx.fillStyle = "#795548"; ctx.fillRect(x - 10, y, 20, 20); // Mug
        ctx.fillStyle = "#c0392b"; ctx.fillRect(x - 10, y, 20, 5); // Rim
        ctx.strokeStyle = "#795548"; ctx.lineWidth = 4;
        ctx.beginPath(); ctx.arc(x + 10, y + 10, 6, 1.5*Math.PI, 0.5*Math.PI); ctx.stroke(); // Handle
        ctx.strokeStyle = "rgba(255,255,255,0.6)"; ctx.lineWidth = 2; // Steam
        let offset = Math.sin((state.frame||0) * 0.1) * 3;
        ctx.beginPath(); ctx.moveTo(x - 5, y - 5); ctx.lineTo(x - 5 + offset, y - 15);
        ctx.moveTo(x + 5, y - 5); ctx.lineTo(x + 5 - offset, y - 15); ctx.stroke();
        ctx.restore();
    }

    function draw(dtCtx = ctx) {
        // Clear background
        dtCtx.fillStyle = "#e3f2fd"; 
        dtCtx.fillRect(0, 0, WIDTH, HEIGHT);

        // Ground snow effect
        dtCtx.fillStyle = "white";
        dtCtx.beginPath(); dtCtx.ellipse(WIDTH/2, HEIGHT + 300, WIDTH, 400, 0, 0, Math.PI*2); dtCtx.fill();

        // Collect all objects for z-ordering (drawing based on Y position)
        const objects = [
            ...trees.map(t => ({type:'tree', ...t, z: t.y})),
            ...grinches.map(g => ({type:'grinch', ...g, z: g.y})),
            ...cocoas.filter(c => c.active).map(c => ({type:'cocoa', ...c, z: c.y})),
            {type:'grandma', ...grandma, z: grandma.y + 20}, // Offset for shadow
            {type:'player', ...player, z: player.y + 15} // Offset for shadow
        ];

        if (!state.hasPurse) {
            objects.push({type:'purse', ...purse, z: purse.y});
        }

        objects.sort((a, b) => a.z - b.z);

        // Draw entities
        objects.forEach(obj => {
            if(obj.type === 'tree') drawTree(dtCtx, obj.x, obj.y, obj.r);
            else if(obj.type === 'grinch') drawGrinch(dtCtx, obj.x, obj.y);
            else if(obj.type === 'cocoa') drawCocoa(dtCtx, obj.x, obj.y + Math.sin((state.frame||0)*0.05 + obj.floatOffset)*5);
            else if(obj.type === 'grandma') drawGrandma(dtCtx, grandma.x, grandma.y);
            else if(obj.type === 'player') {
                drawPlayer(dtCtx, player.x, player.y, player.dir);
                if(state.hasPurse) drawPurse(dtCtx, player.x - 5, player.y + 5); 
            }
            else if(obj.type === 'purse') drawPurse(dtCtx, obj.x, obj.y);
        });

        // Draw falling snow
        dtCtx.fillStyle = "rgba(255, 255, 255, 0.8)";
        snow.forEach(s => {
            dtCtx.beginPath(); dtCtx.arc(s.x, s.y, s.r, 0, Math.PI*2); dtCtx.fill();
        });

        // Draw Joystick (if active)
        if(state.joystick.active) {
            dtCtx.beginPath(); dtCtx.strokeStyle = "rgba(0,0,0,0.1)"; dtCtx.lineWidth = 3;
            dtCtx.arc(state.joystick.originX, state.joystick.originY, 50, 0, Math.PI*2); dtCtx.stroke();
            dtCtx.beginPath(); dtCtx.fillStyle = "rgba(52, 152, 219, 0.5)";
            dtCtx.arc(state.joystick.currX, state.joystick.currY, 25, 0, Math.PI*2); dtCtx.fill();
        }
    }

    function gameLoop() {
        if(state.playing) {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
    }

    // --- UI Icons Logic ---
    function renderIcons() {
        // Draw Purse Icon
        const pCanvas = document.getElementById('icon-purse');
        if (pCanvas) {
            const pCtx = pCanvas.getContext('2d');
            pCtx.translate(20, 25); drawPurse(pCtx, 0, 0);
        }

        // Draw Grandma Icon
        const gCanvas = document.getElementById('icon-grandma');
        if (gCanvas) {
            const gCtx = gCanvas.getContext('2d');
            gCtx.translate(20, 20); drawGrandma(gCtx, 0, 0);
        }

        // Draw Grinch Icon
        const grCanvas = document.getElementById('icon-grinch');
        if (grCanvas) {
            const grCtx = grCanvas.getContext('2d');
            grCtx.translate(20, 20); drawGrinch(grCtx, 0, 0);
        }

        // Draw Cocoa Icon
        const cCanvas = document.getElementById('icon-cocoa');
        if (cCanvas) {
            const cCtx = cCanvas.getContext('2d');
            cCtx.translate(20, 20); drawCocoa(cCtx, 0, 0);
        }

        // Draw Player Icon
        const plCanvas = document.getElementById('icon-player');
        if (plCanvas) {
            const plCtx = plCanvas.getContext('2d');
            plCtx.translate(15, 15); drawPlayer(plCtx, 0, 0, 1);
        }
    }

    // --- UI State Transitions ---

    function endGame(msg) {
        state.playing = false;
        const goScreen = document.getElementById('game-over-screen');
        goScreen.classList.remove('hidden');
        
        document.getElementById('go-title').innerText = "GAME OVER";
        document.getElementById('go-title').style.color = "#c0392b";
        document.getElementById('go-msg').innerText = msg;
        document.getElementById('final-score').innerText = Math.floor(state.score);
        document.getElementById('final-level').innerText = state.level;

        const highscoreSection = document.getElementById('highscore-section');
        highscoreSection.style.display = 'block';
        document.getElementById('save-score-btn').innerText = "Save Score";
        document.getElementById('player-name').value = ''; 
    }

    // Initial Setup
    window.addEventListener('load', () => {
        initFirebase();
        renderIcons(); 
    });

</script>
</body>
</html>